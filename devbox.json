{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
  "packages": [
    "ruby_3_4",
    "nodejs_22",
    "libyaml@latest",
    "libyaml.dev",
    "pkg-config@latest",
    "gcc@latest",
    "gnumake@latest",
    "path:./packages/solr_9_9_0",
    "zookeeper@latest",
    "jdk17@latest",
    "jq@latest",
    "git@latest",
    "redis",
    "zlib",
    "bash@latest",
    "zsh@latest"
  ],
  "env": {
    "DEVBOX":              "1",
    "DEVBOX_BIN":          "$PWD/.devbox/nix/profile/default/bin",
    "PATH":                "$PWD/.devbox/nix/profile/default/bin:$PATH",
    "TMPDIR":              "$PWD/.tmp",
    "BUNDLER_VERSION":     "2.2.27",
    "PKG_CONFIG_PATH":     "$PWD/.devbox/nix/profile/default/lib/pkgconfig:$PWD/.devbox/nix/profile/default/share/pkgconfig",
    "BUNDLE_BUILD__PSYCH": "--with-libyaml-dir=$PWD/.devbox/nix/profile/default --with-pkg-config=$PWD/.devbox/nix/profile/default/bin/pkg-config",
    "PGDATA":              "$PWD/.postgres/data",
    "PGHOST":              "$PWD/.postgres",
    "PGPORT":              "5432",
    "PGUSER":              "$USER",
    "PGDATABASE":          "bibdata",
    "PGPASSWORD":          "",
    "APP_DB_PORT":         "5432",
    "APP_DB_HOST":         "$PWD/.postgres",
    "APP_DB_USERNAME":     "$USER",
    "APP_DB_PASSWORD":     "",
    "APP_DB":              "bibdata",
    "DEVBOX_PGHOST":       "$PWD/.postgres",
    "DEVBOX_PGPORT":       "5432",
    "DEVBOX_PGUSER":       "$USER",
    "DEVBOX_PGDATABASE":   "bibdata",
    "DEVBOX_PGPASSWORD":   "",
    "SOLR_PORT":           "8983",
    "SOLR_BASE":           "$PWD/.solr",
    "SOLR_SERVER":         "$PWD/.solr/server",
    "SOLR_HOME":           "$PWD/.solr/home",
    "SOLR_LOGS_DIR":       "$PWD/.solr/logs",
    "SOLR_PID_DIR":        "$PWD/.solr/pids",
    "SOLR_HOST":           "127.0.0.1",
    "SOLR_URL":            "http://127.0.0.1:8983/solr/bibdata",
    "SOLR_TEST_URL":       "http://solr:SolrRocks@127.0.0.1:8983/solr/bibdata-core-test",
    "SOLR_OPTS":           "-Dlog4j2.disable.jmx=true -Dsolr.disable.jmx=true -Dsolr.log.dir=$PWD/.solr/logs -Dsolr.pid.dir=$PWD/.solr/pids",
    "SOLR_ULIMIT_CHECKS":  "false"
  },
  "shell": {
    "init_hook": [
      "bash -c 'mkdir -p \"$PWD/.tmp\" \"$PWD/.postgres\" \"$SOLR_HOME\" \"$SOLR_LOGS_DIR\" \"$SOLR_PID_DIR\"'",
      "bash -c 'SOLR_BIN_REAL=\"$(readlink -f \"$(command -v solr)\")\"; SOLR_DIST=\"$(dirname \"$(dirname \"$SOLR_BIN_REAL\")\")\"; if [ ! -f \"$SOLR_HOME/solr.xml\" ]; then cp \"$SOLR_DIST/server/solr/solr.xml\" \"$SOLR_HOME/solr.xml\"; cp \"$SOLR_DIST/server/solr/zoo.cfg\" \"$SOLR_HOME/zoo.cfg\"; cp -R \"$SOLR_DIST/server/solr/configsets\" \"$SOLR_HOME/configsets\"; fi; chmod -R u+rwX \"$SOLR_HOME\" \"$SOLR_LOGS_DIR\" \"$SOLR_PID_DIR\"'",
      "bash -c 'mkdir -p \"$(dirname \"$PGDATA\")\"; test -d \"$PGDATA\" || initdb -D \"$PGDATA\" -A trust'"
    ],
    "profile": {
      "bash": ["export PATH=\"$PWD/.devbox/nix/profile/default/bin:$PATH\""],
      "zsh":  ["export PATH=\"$PWD/.devbox/nix/profile/default/bin:$PATH\""]
    },
    "scripts": {
      "setup":                       ["devbox run deps"],
      "deps":                        "bash -c 'set -euo pipefail; export PATH=\"$DEVBOX_BIN:$PATH\"; ruby -v; which ruby; gem install -N bundler -v \"$BUNDLER_VERSION\" >/dev/null 2>&1 || true; bundle _${BUNDLER_VERSION}_ install; yarn install'",
      "postgres-start":              "bash -c 'set -e; mkdir -p \"$PGHOST\"; pg_ctl -D \"$PGDATA\" -l \"$PGHOST/postgres.log\" -o \"-k \\\"$PGHOST\\\" -p $PGPORT -c listen_addresses=\" start'",
      "postgres-stop":               "pg_ctl -D \"$PGDATA\" -m fast stop || true",
      "postgres-status":             "pg_ctl -D \"$PGDATA\" status || true",
      "postgres-log":                "tail -200 \"$PWD/.postgres/postgres.log\" || true",
      "postgres-ensure":             "bash -c '\nset -e\nmkdir -p \"$PGDATA\" \"$PGHOST\"\npg_isready -h \"$PGHOST\" -p \"$PGPORT\" >/dev/null 2>&1 && exit 0\nPIDFILE=\"$PGDATA/postmaster.pid\"\nif [ -f \"$PIDFILE\" ]; then\n  PID=$(head -1 \"$PIDFILE\" || true)\n  if [ -n \"$PID\" ] && ! kill -0 \"$PID\" 2>/dev/null; then\n    rm -f \"$PIDFILE\"\n  fi\nfi\npg_ctl -D \"$PGDATA\" -l \"$PWD/.postgres/postgres.log\" -o \"-p $PGPORT -k $PGHOST -c listen_addresses=\" start\nfor i in $(seq 1 50); do\n  pg_isready -h \"$PGHOST\" -p \"$PGPORT\" >/dev/null 2>&1 && exit 0\n  sleep 0.1\ndone\necho \"Postgres did not become ready\" >&2\ntail -200 \"$PWD/.postgres/postgres.log\" || true\nexit 1\n'",
      "db-create":                   "bash -c 'set -euo pipefail; export PATH=\"$DEVBOX_BIN:$PATH\"; devbox run postgres-ensure >/dev/null; bundle _${BUNDLER_VERSION}_ exec rails db:create'",
      "db-migrate":                  "bash -c 'set -euo pipefail; export PATH=\"$DEVBOX_BIN:$PATH\"; devbox run postgres-ensure >/dev/null; bundle _${BUNDLER_VERSION}_ exec rails db:migrate'",
      "solr-log":                    "bash -c 'ls -al \"$SOLR_LOGS_DIR\" || true; tail -200 \"$SOLR_LOGS_DIR\"/*.log 2>/dev/null || true'",
      "solr-status":                 "bash -c 'OS=$(uname -s); EXTRA=\"\"; if [ \"$OS\" != \"Darwin\" ]; then EXTRA=\"-XX:-UseContainerSupport\"; fi; JAVA_TOOL_OPTIONS=\"-Dlog4j2.disable.jmx=true -Dsolr.disable.jmx=true $EXTRA\" solr status -p \"$SOLR_PORT\" || true; ss -ltn 2>/dev/null | grep \":$SOLR_PORT\" || true'",
      "solr-start":                  "bash -c 'set -e; OS=$(uname -s); EXTRA=\"\"; if [ \"$OS\" != \"Darwin\" ]; then EXTRA=\"-XX:-UseContainerSupport\"; fi; if [ \"$OS\" = \"Darwin\" ]; then env -u JAVA_TOOL_OPTIONS JAVA_TOOL_OPTIONS=\"-Dlog4j2.disable.jmx=true -Dsolr.disable.jmx=true\" solr start -cloud -p \"$SOLR_PORT\" -s \"$SOLR_HOME\" -a \"$SOLR_OPTS\"; else JAVA_TOOL_OPTIONS=\"-Dlog4j2.disable.jmx=true -Dsolr.disable.jmx=true $EXTRA\" solr start -cloud -p \"$SOLR_PORT\" -s \"$SOLR_HOME\" -a \"$SOLR_OPTS $EXTRA\"; fi'",
      "solr-stop":                   "bash -c 'OS=$(uname -s); if [ \"$OS\" = \"Darwin\" ]; then env -u JAVA_TOOL_OPTIONS solr stop -p \"$SOLR_PORT\" || true; else solr stop -p \"$SOLR_PORT\" || true; fi'",
      "solr-assert-cloud":           "bash -c 'set -euo pipefail; mode=$(curl -fsS -u solr:SolrRocks \"http://$SOLR_HOST:$SOLR_PORT/solr/admin/info/system?wt=json\" | jq -r .mode); test \"$mode\" = \"solrcloud\" || { echo \"Expected solrcloud mode, got $mode\" >&2; exit 1; }'",
      "solr-create-collection":      "bash -c 'set -e; COLLECTION=pdc-core-dev; CONFIGSET=pdc_discovery; # Upload configset if missing\nif ! curl -fsS \"http://solr:SolrRocks@$SOLR_HOST:$SOLR_PORT/solr/admin/configs?action=LIST&wt=json\" | grep -q \"\\\"$CONFIGSET\\\"\"; then\n  solr zk upconfig -z localhost:9983 -n \"$CONFIGSET\" -d \"$PWD/solr/conf\";\nfi\n# Create collection if missing\nif curl -fsS \"http://solr:SolrRocks@$SOLR_HOST:$SOLR_PORT/solr/admin/collections?action=LIST&wt=json\" | grep -q \"\\\"$COLLECTION\\\"\"; then\n  echo \"Collection $COLLECTION already exists\";\nelse\n  solr create_collection -c \"$COLLECTION\" -n \"$CONFIGSET\" -shards 1 -replicationFactor 1 -p \"$SOLR_PORT\";\nfi'",
      "solr-create-test-collection": "bash -c 'set -euo pipefail; curl -fsS --retry 10 --retry-delay 1 -u \"solr:SolrRocks\" -H \"Content-type: application/json\" \"http://$SOLR_HOST:$SOLR_PORT/api/collections/\" -d \"{\\\"create\\\": {\\\"name\\\": \\\"pdc_discovery-core-test\\\", \\\"config\\\": \\\"pdc_discovery\\\", \\\"numShards\\\": 1}}\"'",
      "solr-upload-config":          "bash -c 'set -euo pipefail; ROOT=\"$PWD\"; mkdir -p \"$ROOT/.tmp\"; ZIP=\"$ROOT/.tmp/solr_config.zip\"; rm -f \"$ZIP\"; (cd \"$ROOT/solr/conf\" && zip -q -1 -r \"$ZIP\" ./*); curl -fsS -u solr:SolrRocks \"http://$SOLR_HOST:$SOLR_PORT/solr/admin/configs?action=DELETE&name=pdc_discovery&wt=json\" || true; curl -fsS -u solr:SolrRocks -H \"Content-type:application/octet-stream\" --data-binary @\"$ZIP\" \"http://$SOLR_HOST:$SOLR_PORT/solr/admin/configs?action=UPLOAD&name=pdc_discovery\"'",
      "solr-upload-security-config": "bash -c 'set -e; mkdir -p .tmp; curl -fsSL -o .tmp/security.json \"https://gist.githubusercontent.com/eliotjordan/a27be341dc2e7a532bad99203e0f55b7/raw/5866efab9242f953764c1b03d17763309e22948f/security.json\"; solr zk cp .tmp/security.json zk:security.json -z $SOLR_HOST:9983'",
      "solr-test-ready":             "bash -c 'set -euo pipefail; devbox run solr-stop >/dev/null 2>&1 || true; devbox run solr-start; devbox run solr-assert-cloud; devbox run solr-upload-security-config; devbox run solr-upload-config; devbox run solr-create-test-collection'",
      "zsh":                         "zsh -l"
    }
  }
}
